<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Guowei Lv">
<meta name="generator" content="Hugo 0.25.1" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://lvguowei.me/css/style.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
<link rel="alternate" href="http://lvguowei.me/index.xml" type="application/rss+xml" title="Guowei Lv">
<title>All You Need To Know About Android Espresso Testing (Part I) - Guowei Lv</title>
</head>
<body>

<header>
  <div class="container clearfix">
    <a class="path" href="http://lvguowei.me/">[Guowei Lv]</a>
    <span class="caret"># _</span>
    <div class="right">
      
    </div>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2017-07-13">July 13, 2017</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="http://lvguowei.me/categories/programming">programming</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="http://lvguowei.me/tags/android">Android</a>

        <a href="http://lvguowei.me/tags/espresso">Espresso</a>

        <a href="http://lvguowei.me/tags/testing">Testing</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">All You Need To Know About Android Espresso Testing (Part I)</h1>
  <section class="body" itemprop="articleBody">
    

<p>The Espresso testing framework really makes it easy to write UI tests for Android. In this first installment, I will go through how to set it up and write our first test case.</p>

<p>Let&rsquo;s get started.</p>

<h2 id="set-up-espresso">Set up Espresso</h2>

<p>Add the following dependencies to your gradle build file.</p>

<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span></span><span class="n">dependencies</span> <span class="o">{</span>
    <span class="c1">// Other dependencies ...</span>
    <span class="n">androidTestCompile</span> <span class="s1">&#39;com.android.support.test.espresso:espresso-core:2.2.2&#39;</span>
<span class="o">}</span>
</code></pre></div>


<h2 id="understand-the-rules-in-junit">Understand the Rules in JUnit</h2>

<h3 id="why-do-they-exist">Why do they exist?</h3>

<p>We all know that in JUnit there is a setup method(annotated as @Before) and a teardown method(annotated as @After). They will run before and after each test respectively. This handles simple senarios pretty well, but it has 2 drawbacks:</p>

<ol>
<li><p>They are two separate thing, it is very easy to do the setup work but forget to do the clean up work, what makes this worse is that if you forget to clean up, <em>this</em> test won&rsquo;t fail, <em>other</em> test may fail. So it becomes very hard to track things down when tests are failing.</p></li>

<li><p>Let&rsquo;s imagine that there are some code for setting up and tearing down the database in database tests, and there are some other code for setting up and tearing down the file handle in the file system tests. Now, what if we want to write tests that involves both file system and the database? Since we are smart, of course we create a <code>FileSystemAndDatabaseBaseTests</code> that handles both. Well, what if we want to then write tests that involves both database and networking? Should we create another base class called <code>DatabaseAndNetworkingBaseTests</code>? This certainly doesn&rsquo;t scale, soon we will end up with piles upon piles of inheritance classes, because the setup and tear down works can not compose nicely. This is essentially a classic <em>prefer composing over inheritance</em> case.</p></li>
</ol>

<p>So a <code>Rule</code> is basically aiming to solve these problems.</p>

<h3 id="how-junit-works-internally">How JUnit works internally</h3>

<p>In order to understand <code>Rules</code> better, let&rsquo;s first look at how JUnit works on a higher level.</p>

<p>Tests are annotated by <code>@Test</code>, so that JUnit can convert them into some small classes called <code>Statement</code>.</p>


<figure >
    
        <img src="http://lvguowei.me/img/test-to-statement.png" />
    
    
</figure>


<p>The <code>Statement</code> is a very simple class:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Statement</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Run the action, throwing a {@code Throwable} if anything goes wrong.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>


<p>This <code>Statement</code> is actually an empty base class with only one method. Looks a lot like a <a href="https://en.wikipedia.org/wiki/Command_pattern">Command Pattern</a>, huh?</p>

<p>So we can say that JUnit goes through all the functions annotated with <code>@Test</code>, create a bunch of command objects(Statements), and then execute them by calling <code>evaluate()</code>.</p>

<h3 id="what-is-a-rule">What is a Rule</h3>

<p>Now we have a basic understanding of how JUnit creates test objects and then execute them, we can talk about where <code>Rule</code> kicks in.</p>

<p>A <code>Rule</code> is a kind of <em>function</em> (notice that in Java, since function is not first class citizen, is normally represented by an Interface), that takes a <code>Statement</code> in, and returns a <code>Statement</code> back.</p>


<figure >
    
        <img src="http://lvguowei.me/img/rule.png" />
    
    
</figure>


<p>Now let&rsquo;s take a look at the code:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TestRule</span> <span class="o">{</span>

<span class="cm">/**</span>
<span class="cm">     * Modifies the method-running {@link Statement} to implement this</span>
<span class="cm">     * test-running rule.</span>
<span class="cm">     *</span>
<span class="cm">     * @param base The {@link Statement} to be modified</span>
<span class="cm">     * @param description A {@link Description} of the test implemented in {@code base}</span>
<span class="cm">     * @return a new statement, which may be the same as {@code base},</span>
<span class="cm">     *         a wrapper around {@code base}, or a completely new Statement.</span>
<span class="cm">     */</span>
    <span class="n">Statement</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>


<p>From the comments we can probably guess that this is a <a href="https://en.wikipedia.org/wiki/Decorator_pattern">Decorator Pattern</a>. It provides a way to do extra work before or after the original test, aka a single place to do both <code>before</code> and <code>after</code> work. And the best part is that it is even composable like this:</p>


<figure >
    
        <img src="http://lvguowei.me/img/rules-chain.png" />
    
    
</figure>


<p>To understand this better, let&rsquo;s implement a Rule.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleRule</span> <span class="n">implement</span> <span class="n">TestRule</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Statement</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Statement</span> <span class="n">s</span><span class="o">,</span> <span class="n">Description</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Statement</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                <span class="c1">// do more before test run here</span>
                <span class="n">s</span><span class="o">.</span><span class="na">evaluate</span><span class="o">();</span>
                <span class="c1">// do more after test run here</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>


<p>In the sample code, we have now a place to very easily put in extra logic before and after the test run.</p>

<h2 id="add-the-activity-test-rule">Add the activity test rule</h2>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Rule</span>
<span class="kd">public</span> <span class="n">ActivityTestRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityTestRule</span><span class="o">&lt;&gt;(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div>


<p>This rule basically launches and specified activity before test, and destroy it after test, so we don&rsquo;t have to set this up ourselves.</p>

<h2 id="a-simple-test-case">A simple test case</h2>

<p>Now we can start writing our first test case, which is as simple as checking some string is displayed.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldBeAbleToLaunchMainScreen</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">onView</span><span class="o">(</span><span class="n">withText</span><span class="o">(</span><span class="s">&quot;Hello World&quot;</span><span class="o">)).</span><span class="na">check</span><span class="o">(</span><span class="n">ViewAssertions</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">isDisplayed</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div>


<p>There are 3 parts for every espresso test: <code>onView</code>, <code>perform</code> and <code>check</code>. <code>onView</code> makes sure that the view is on the screen before we proceed with the test. <code>perform</code> allows simulating some user input on the view, and <code>check</code> is checking the final state the view is in.</p>

<p>There is a <a href="https://google.github.io/android-testing-support-library/docs/espresso/cheatsheet/">cheat sheet</a> that is quite useful.</p>

<h2 id="using-uiautomatorviewer">Using uiautomatorviewer</h2>

<p>Notice that in the previous test, we find the view by making a text match, this has several problems. The text can change quite often and what if the app is internationalized? All these makes the test to be fragile. We can eliminate these shortcomings by using the view&rsquo;s id. But finding the view&rsquo;s id can be cumbersome. Here is what uiautomatorviewer can help. Using it, we can very quickly access the view&rsquo;s information including its id. Launch it (in ANDROID-SDK-PATH/Sdk/tools/bin/) and should be easy to figure out how to use it.</p>

  </section>

  <br/>

  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lvguoweime" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>

</main>


</div>
<footer>
  <div class="container">
    <span class="copyright">&copy; 2017  Guowei Lv</span>
  </div>
</footer>

</body>
</html>

